<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Scavenger Hunt - Hamilton Place</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
            transition: background 0.5s ease;
        }

        body.theme-mom {
            background: linear-gradient(135deg, #e91e63 0%, #f06292 100%);
        }

        body.theme-dad {
            background: linear-gradient(135deg, #2196f3 0%, #64b5f6 100%);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            transition: background 0.5s ease;
        }

        body.theme-mom .header {
            background: linear-gradient(135deg, #e91e63 0%, #f06292 100%);
        }

        body.theme-dad .header {
            background: linear-gradient(135deg, #2196f3 0%, #64b5f6 100%);
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .storage-status {
            font-size: 0.85em;
            margin-top: 10px;
            padding: 5px 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            display: inline-block;
        }

        .storage-status.cloud {
            background: rgba(76, 175, 80, 0.3);
        }

        .team-selector-section {
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .team-selector-section h3 {
            color: white;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .team-selector-global {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        .team-btn-global {
            padding: 12px 25px;
            border: 3px solid white;
            background: rgba(255, 255, 255, 0.4);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .team-btn-global.mom {
            background: rgba(233, 30, 99, 0.5);
            border-color: rgba(233, 30, 99, 0.8);
        }

        .team-btn-global.dad {
            background: rgba(33, 150, 243, 0.5);
            border-color: rgba(33, 150, 243, 0.8);
        }

        .team-btn-global:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        .team-btn-global.mom:hover {
            background: rgba(233, 30, 99, 0.7);
        }

        .team-btn-global.dad:hover {
            background: rgba(33, 150, 243, 0.7);
        }

        .team-btn-global.active {
            background: white;
            color: #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .team-btn-global.mom.active {
            background: #e91e63;
            color: white;
            border-color: #e91e63;
        }

        .team-btn-global.dad.active {
            background: #2196f3;
            color: white;
            border-color: #2196f3;
        }

        .timer-section {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }

        .time-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .time-input-group input {
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 1em;
        }

        .btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .btn:hover {
            background: #5568d3;
        }

        body.theme-mom .btn {
            background: #e91e63;
        }

        body.theme-mom .btn:hover {
            background: #c2185b;
        }

        body.theme-dad .btn {
            background: #2196f3;
        }

        body.theme-dad .btn:hover {
            background: #1976d2;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .countdown {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .countdown.show {
            display: block;
        }

        .countdown-display {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
            transition: color 0.5s ease;
        }

        body.theme-mom .countdown-display {
            color: #e91e63;
        }

        body.theme-dad .countdown-display {
            color: #2196f3;
        }

        .countdown-label {
            font-size: 1.2em;
            color: #666;
        }

        .hunt-ended {
            text-align: center;
            padding: 20px;
            background: #d4edda;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            margin: 20px;
            display: none;
        }

        .hunt-ended.show {
            display: block;
        }

        .hunt-ended h2 {
            color: #4CAF50;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .scavenger-list {
            padding: 20px;
        }

        .scavenger-list h2 {
            margin-bottom: 15px;
            color: #667eea;
            transition: color 0.5s ease;
        }

        body.theme-mom .scavenger-list h2 {
            color: #e91e63;
        }

        body.theme-dad .scavenger-list h2 {
            color: #2196f3;
        }

        .item {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }

        .item-info {
            flex: 1;
            min-width: 200px;
        }

        .item-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .item-description {
            font-size: 0.9em;
            color: #666;
        }

        .item-photos {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .photo-preview {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #667eea;
        }

        .upload-btn {
            padding: 8px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s ease;
        }

        .upload-btn:hover {
            background: #45a049;
        }

        body.theme-mom .upload-btn {
            background: #e91e63;
        }

        body.theme-mom .upload-btn:hover {
            background: #c2185b;
        }

        body.theme-dad .upload-btn {
            background: #2196f3;
        }

        body.theme-dad .upload-btn:hover {
            background: #1976d2;
        }

        .file-input {
            display: none;
        }

        .team-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .team-btn {
            padding: 8px 15px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .team-btn.active {
            background: #667eea;
            color: white;
        }

        .team-btn.mom {
            border-color: #e91e63;
        }

        .team-btn.mom.active {
            background: #e91e63;
            border-color: #e91e63;
        }

        .team-btn.dad {
            border-color: #2196f3;
        }

        .team-btn.dad.active {
            background: #2196f3;
            border-color: #2196f3;
        }

        .scores-section {
            padding: 20px;
            background: #f8f9fa;
            border-top: 2px solid #e0e0e0;
            display: none;
        }

        .scores-section.show {
            display: block;
        }

        .scores-title {
            text-align: center;
            margin-bottom: 20px;
            color: #667eea;
            transition: color 0.5s ease;
        }

        body.theme-mom .scores-title {
            color: #e91e63;
        }

        body.theme-dad .scores-title {
            color: #2196f3;
        }

        .scores-container {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            flex-wrap: wrap;
        }

        .team-score {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 15px;
            min-width: 200px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .team-score.mom {
            border: 3px solid #e91e63;
        }

        .team-score.dad {
            border: 3px solid #2196f3;
        }

        .team-score h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .team-score.mom h3 {
            color: #e91e63;
        }

        .team-score.dad h3 {
            color: #2196f3;
        }

        .score-number {
            font-size: 3em;
            font-weight: bold;
            color: #333;
        }

        .photos-gallery {
            padding: 20px;
            display: none;
        }

        .photos-gallery.show {
            display: block;
        }

        .photos-gallery h2 {
            margin-bottom: 20px;
            color: #667eea;
            transition: color 0.5s ease;
        }

        body.theme-mom .photos-gallery h2 {
            color: #e91e63;
        }

        body.theme-dad .photos-gallery h2 {
            color: #2196f3;
        }

        .photo-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .photo-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .photo-item-title {
            font-weight: 600;
            color: #667eea;
        }

        .photo-item-team {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .photo-item-team.mom {
            background: #e91e63;
            color: white;
        }

        .photo-item-team.dad {
            background: #2196f3;
            color: white;
        }

        .photo-item-image {
            width: 100%;
            max-width: 500px;
            border-radius: 8px;
            display: block;
            margin: 0 auto;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .countdown-display {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∏ Photo Scavenger Hunt üì∏</h1>
            <p>Hamilton Place Area - Chattanooga, TN</p>
            <div class="storage-status" id="storageStatus">üíæ Local Storage</div>
        </div>

        <div class="team-selector-section">
            <h3>Choose Your Team:</h3>
            <div class="team-selector-global">
                <button class="team-btn-global mom" id="teamBtnMom" onclick="selectTeamGlobal('mom')">üë© Mom Team</button>
                <button class="team-btn-global dad" id="teamBtnDad" onclick="selectTeamGlobal('dad')">üë® Dad Team</button>
            </div>
        </div>

        <div class="timer-section">
            <div class="time-input-group" id="timeInputGroup">
                <label for="endTime">Hunt Ends At:</label>
                <input type="datetime-local" id="endTime" />
                <button class="btn" onclick="setEndTime()">Start Hunt</button>
            </div>
            <div class="countdown" id="countdown">
                <div class="countdown-label">Time Remaining:</div>
                <div class="countdown-display" id="countdownDisplay">00:00:00</div>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 10px;">
                    <button class="btn btn-secondary" onclick="showTimeAdjust()">Adjust Time</button>
                    <button class="btn btn-danger" onclick="clearHunt()">Clear Hunt</button>
                </div>
            </div>
        </div>

        <div class="hunt-ended" id="huntEnded">
            <h2>üéâ Hunt is Over! üéâ</h2>
            <p>Time to see the results!</p>
            <button class="btn btn-danger" onclick="clearHunt()" style="margin-top: 15px;">Clear Hunt</button>
        </div>

        <div class="scavenger-list" id="scavengerList">
            <h2>Find & Photograph:</h2>
            <!-- Items will be populated by JavaScript -->
        </div>

        <div class="scores-section" id="scoresSection">
            <h2 class="scores-title">Final Scores</h2>
            <div class="scores-container">
                <div class="team-score mom">
                    <h3>üë© Mom Team</h3>
                    <div class="score-number" id="momScore">0</div>
                    <div>photos</div>
                </div>
                <div class="team-score dad">
                    <h3>üë® Dad Team</h3>
                    <div class="score-number" id="dadScore">0</div>
                    <div>photos</div>
                </div>
            </div>
        </div>

        <div class="photos-gallery" id="photosGallery">
            <h2>All Photos</h2>
            <!-- Photos will be populated by JavaScript -->
        </div>
    </div>

    <script>
        const items = [
            { id: 'mall-sign', title: 'Hamilton Place Mall Sign', description: 'The main mall entrance sign' },
            { id: 'food-court', title: 'Food Court', description: 'Any food court area or sign' },
            { id: 'parking-lot', title: 'Parking Lot Feature', description: 'A unique parking lot feature or sign' },
            { id: 'store-window', title: 'Store Window Display', description: 'An interesting store window display' },
            { id: 'restaurant-sign', title: 'Restaurant Sign', description: 'A restaurant sign near the mall' },
            { id: 'street-sign', title: 'Street Sign', description: 'A street sign with "Hamilton" in the name' },
            { id: 'fountain', title: 'Fountain or Water Feature', description: 'Any fountain or water feature' },
            { id: 'bench', title: 'Decorative Bench', description: 'A bench or seating area' },
            { id: 'tree', title: 'Unique Tree', description: 'An interesting or large tree' },
            { id: 'statue', title: 'Statue or Sculpture', description: 'Any statue or art sculpture' },
            { id: 'flag', title: 'American Flag', description: 'An American flag flying' },
            { id: 'signage', title: 'Directional Sign', description: 'A directional or wayfinding sign' },
            { id: 'lighting', title: 'Decorative Lighting', description: 'Decorative lights or lamp posts' },
            { id: 'landscaping', title: 'Landscaping Feature', description: 'Interesting landscaping or garden area' },
            { id: 'vehicle', title: 'Unique Vehicle', description: 'An interesting or unique vehicle in parking lot' },
            { id: 'entrance', title: 'Store Entrance', description: 'An interesting store entrance or door' }
        ];

        let selectedTeam = 'mom';
        let endTime = null;
        let countdownInterval = null;
        let firebaseStorage = null;
        let useFirebase = false;
        let endTimeSyncInterval = null;

        // Initialize Firebase if configured
        function initFirebase() {
            console.log('Initializing Firebase...');
            console.log('firebaseConfig defined:', typeof firebaseConfig !== 'undefined');
            console.log('USE_FIREBASE:', typeof USE_FIREBASE !== 'undefined' ? USE_FIREBASE : 'undefined');
            
            if (typeof firebaseConfig !== 'undefined' && typeof USE_FIREBASE !== 'undefined' && USE_FIREBASE && firebaseConfig.apiKey !== 'YOUR_API_KEY_HERE') {
                try {
                    firebase.initializeApp(firebaseConfig);
                    firebaseStorage = firebase.storage();
                    useFirebase = true;
                    document.getElementById('storageStatus').textContent = '‚òÅÔ∏è Cloud Storage (Firebase)';
                    document.getElementById('storageStatus').classList.add('cloud');
                    console.log('Firebase Storage initialized successfully');
                } catch (error) {
                    console.error('Firebase initialization error:', error);
                    useFirebase = false;
                    document.getElementById('storageStatus').textContent = 'üíæ Local Storage (Firebase Error)';
                }
            } else {
                if (typeof firebaseConfig === 'undefined') {
                    console.warn('firebase-config.js not loaded or firebaseConfig not defined');
                } else if (typeof USE_FIREBASE === 'undefined') {
                    console.warn('USE_FIREBASE not defined in firebase-config.js');
                } else if (!USE_FIREBASE) {
                    console.log('USE_FIREBASE is set to false');
                } else if (firebaseConfig.apiKey === 'YOUR_API_KEY_HERE') {
                    console.warn('Firebase config not filled in - using template values');
                }
                console.log('Using localStorage for photo storage');
                document.getElementById('storageStatus').textContent = 'üíæ Local Storage';
            }
        }

        // Initialize
        async function init() {
            initFirebase();
            loadTeamSelection();
            
            // Load data - try Firebase first if available
            if (useFirebase && firebaseStorage) {
                // Try to load from Firebase first - this will update endTime if found
                // This MUST complete before we check localStorage
                await syncEndTimeFromFirebase();
                
                // Only check localStorage if Firebase didn't have a time
                // This ensures Firebase always takes precedence
                if (!endTime) {
                    const savedEndTime = localStorage.getItem('huntEndTime');
                    if (savedEndTime) {
                        const localTime = new Date(savedEndTime);
                        // Only use localStorage if it's valid and in the future
                        if (localTime && !isNaN(localTime.getTime())) {
                            endTime = localTime;
                            // Sync it back to Firebase
                            await saveEndTimeToFirebase(endTime);
                            document.getElementById('timeInputGroup').style.display = 'none';
                            if (endTime > new Date()) {
                                startCountdown();
                            } else {
                                showHuntEnded();
                            }
                        }
                    }
                }
                
                await loadPhotosFromFirebase();
                
                // Start periodic syncs
                endTimeSyncInterval = setInterval(syncEndTimeFromFirebase, 3000);
                setInterval(syncPhotosFromFirebase, 3000);
            } else {
                // Fallback to localStorage only
                await loadData();
            }
            
            renderItems();
            checkHuntStatus();
        }

        // Sync end time from Firebase (for multi-device sync)
        async function syncEndTimeFromFirebase() {
            if (!useFirebase || !firebaseStorage) {
                console.log('Firebase not available for sync');
                return;
            }
            
            try {
                console.log('Attempting to load huntEndTime.json from Firebase Storage...');
                const endTimeRef = firebaseStorage.ref().child('huntEndTime.json');
                console.log('Firebase Storage reference created');
                
                // Try using getBytes first (avoids CORS issues) if available
                let data;
                if (typeof endTimeRef.getBytes === 'function') {
                    try {
                        const bytes = await endTimeRef.getBytes();
                        const text = new TextDecoder('utf-8').decode(bytes);
                        data = JSON.parse(text);
                        console.log('Loaded end time from Firebase using getBytes:', data);
                    } catch (bytesError) {
                        console.log('getBytes failed, trying download URL method:', bytesError);
                        // Fall through to download URL method
                    }
                }
                
                // Fallback to download URL method if getBytes not available or failed
                if (!data) {
                    try {
                        const url = await endTimeRef.getDownloadURL();
                        console.log('Download URL obtained:', url);
                        
                        // Use XMLHttpRequest instead of fetch to avoid CORS preflight
                        data = await new Promise((resolve, reject) => {
                            const xhr = new XMLHttpRequest();
                            xhr.open('GET', url, true);
                            xhr.onload = function() {
                                if (xhr.status === 200) {
                                    try {
                                        resolve(JSON.parse(xhr.responseText));
                                    } catch (e) {
                                        reject(new Error('Failed to parse JSON: ' + e.message));
                                    }
                                } else {
                                    reject(new Error(`HTTP error! status: ${xhr.status}`));
                                }
                            };
                            xhr.onerror = function() {
                                reject(new Error('Network error'));
                            };
                            xhr.send();
                        });
                        console.log('Loaded end time from Firebase using download URL:', data);
                    } catch (urlError) {
                        throw urlError;
                    }
                }
                
                if (data.endTime) {
                    const firebaseEndTime = new Date(data.endTime);
                    // Only update if Firebase has a different time (someone else changed it) or we don't have one locally
                    if (!endTime || firebaseEndTime.getTime() !== endTime.getTime()) {
                        console.log('Updating end time from Firebase');
                        endTime = firebaseEndTime;
                        localStorage.setItem('huntEndTime', endTime.toISOString());
                        
                        // Hide time input and show countdown
                        document.getElementById('timeInputGroup').style.display = 'none';
                        
                        // Restart countdown if needed
                        if (countdownInterval) {
                            clearInterval(countdownInterval);
                        }
                        if (endTime > new Date()) {
                            startCountdown();
                            // Re-render items to show/hide upload buttons
                            document.getElementById('scavengerList').innerHTML = '<h2>Find & Photograph:</h2>';
                            renderItems();
                        } else {
                            showHuntEnded();
                        }
                    } else {
                        console.log('End time already matches Firebase');
                    }
                }
            } catch (error) {
                // File doesn't exist or error
                console.log('Error loading end time from Firebase:', error);
                console.log('Error details:', {
                    message: error.message,
                    code: error.code,
                    name: error.name
                });
                
                // Check if it's a CORS error
                if (error.message && error.message.includes('CORS')) {
                    console.error('CORS Error: Firebase Storage needs CORS configuration for swift-turtle.com');
                    console.error('See FIREBASE-CORS-SETUP.md for instructions');
                }
                
                // Check if it's a 404 (file doesn't exist)
                if (error.code === 'storage/object-not-found' || 
                    error.code === 'storage/404' ||
                    (error.message && (error.message.includes('404') || error.message.includes('object-not-found')))) {
                    console.log('huntEndTime.json does not exist in Firebase Storage yet - this is normal if no hunt has been started');
                    // Don't show error, just log it - this is expected on first load
                    return;
                }
                
                // If we don't have a local end time either, show the input
                if (!endTime) {
                    document.getElementById('timeInputGroup').style.display = 'flex';
                }
            }
        }

        // Load saved team selection
        function loadTeamSelection() {
            const savedTeam = localStorage.getItem('selectedTeam');
            if (savedTeam) {
                selectTeamGlobal(savedTeam, false);
            } else {
                selectTeamGlobal('mom', false);
            }
        }

        // Load saved data (localStorage only - used when Firebase is not available)
        async function loadData() {
            // Only use this when Firebase is NOT available
            const savedEndTime = localStorage.getItem('huntEndTime');
            if (savedEndTime) {
                endTime = new Date(savedEndTime);
                
                // Hide time input and show countdown
                document.getElementById('timeInputGroup').style.display = 'none';
                
                if (endTime > new Date()) {
                    startCountdown();
                } else {
                    showHuntEnded();
                }
            }
        }

        // Save end time to Firebase
        async function saveEndTimeToFirebase(endTimeValue) {
            if (!useFirebase || !firebaseStorage) return;
            
            try {
                const endTimeRef = firebaseStorage.ref().child('huntEndTime.json');
                const data = { endTime: endTimeValue.toISOString() };
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                await endTimeRef.put(blob);
                console.log('End time saved to Firebase');
            } catch (error) {
                console.error('Error saving end time to Firebase:', error);
            }
        }

        // Set end time
        async function setEndTime() {
            const input = document.getElementById('endTime');
            const timeValue = input.value;
            
            if (!timeValue) {
                alert('Please select an end time!');
                return;
            }

            endTime = new Date(timeValue);
            localStorage.setItem('huntEndTime', endTime.toISOString());
            
            // Save to Firebase
            await saveEndTimeToFirebase(endTime);
            
            document.getElementById('timeInputGroup').style.display = 'none';
            startCountdown();
            
            // Re-render items to show upload buttons
            document.getElementById('scavengerList').innerHTML = '<h2>Find & Photograph:</h2>';
            renderItems();
        }

        // Show time adjust
        function showTimeAdjust() {
            document.getElementById('timeInputGroup').style.display = 'flex';
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            // Pre-fill the input with current end time if it exists
            if (endTime) {
                const input = document.getElementById('endTime');
                const localDateTime = new Date(endTime.getTime() - endTime.getTimezoneOffset() * 60000)
                    .toISOString()
                    .slice(0, 16);
                input.value = localDateTime;
            }
        }

        // Start countdown
        function startCountdown() {
            document.getElementById('countdown').classList.add('show');
            updateCountdown();
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        // Update countdown
        function updateCountdown() {
            if (!endTime) return;

            const now = new Date();
            const diff = endTime - now;

            if (diff <= 0) {
                clearInterval(countdownInterval);
                showHuntEnded();
                return;
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            const display = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('countdownDisplay').textContent = display;
        }

        // Show hunt ended
        function showHuntEnded() {
            document.getElementById('huntEnded').classList.add('show');
            document.getElementById('countdown').classList.remove('show');
            document.getElementById('scoresSection').classList.add('show');
            document.getElementById('photosGallery').classList.add('show');
            updateScores();
            renderGallery();
        }

        // Check hunt status
        function checkHuntStatus() {
            if (endTime && endTime <= new Date()) {
                showHuntEnded();
            }
        }

        // Render items
        function renderItems() {
            const container = document.getElementById('scavengerList');
            // Clear existing items (but keep the h2 if it exists)
            const existingItems = container.querySelectorAll('.item');
            existingItems.forEach(item => item.remove());
            
            items.forEach(item => {
                const photos = getPhotosForItem(item.id);
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                itemDiv.innerHTML = `
                    <div class="item-info">
                        <div class="item-title">${item.title}</div>
                        <div class="item-description">${item.description}</div>
                    </div>
                    <div class="item-photos">
                        ${photos.map(photo => `
                            <img src="${photo.data}" alt="Photo" class="photo-preview" onclick="viewPhoto('${item.id}', '${photo.id}')" />
                        `).join('')}
                        ${endTime && endTime > new Date() ? `
                            <div>
                                <input type="file" accept="image/*" class="file-input" id="file-${item.id}" onchange="uploadPhoto('${item.id}', this)" />
                                <button class="upload-btn" onclick="document.getElementById('file-${item.id}').click()">üì∑ Add Photo</button>
                            </div>
                        ` : ''}
                    </div>
                `;
                container.appendChild(itemDiv);
            });
        }

        // Select team globally and update theme
        function selectTeamGlobal(team, save = true) {
            selectedTeam = team;
            
            // Update button states
            document.getElementById('teamBtnMom').classList.remove('active');
            document.getElementById('teamBtnDad').classList.remove('active');
            
            if (team === 'mom') {
                document.getElementById('teamBtnMom').classList.add('active');
                document.body.className = 'theme-mom';
            } else {
                document.getElementById('teamBtnDad').classList.add('active');
                document.body.className = 'theme-dad';
            }
            
            // Save to localStorage
            if (save) {
                localStorage.setItem('selectedTeam', team);
            }
        }

        // Upload photo
        async function uploadPhoto(itemId, input) {
            const file = input.files[0];
            if (!file) return;

            const photoId = Date.now().toString();
            const timestamp = new Date().toISOString();

            if (useFirebase && firebaseStorage) {
                // Upload to Firebase Storage
                try {
                    const storageRef = firebaseStorage.ref();
                    const photoRef = storageRef.child(`photos/${photoId}_${file.name}`);
                    
                    // Show upload progress
                    const uploadBtn = input.nextElementSibling;
                    const originalText = uploadBtn.textContent;
                    uploadBtn.textContent = '‚è≥ Uploading...';
                    uploadBtn.disabled = true;

                    const snapshot = await photoRef.put(file);
                    const downloadURL = await snapshot.ref.getDownloadURL();

                    const photo = {
                        id: photoId,
                        itemId: itemId,
                        team: selectedTeam,
                        url: downloadURL, // Store URL instead of base64
                        data: downloadURL, // For compatibility
                        timestamp: timestamp,
                        filename: file.name
                    };

                    const photos = getPhotos();
                    photos.push(photo);
                    await savePhotos(photos);
                    
                    uploadBtn.textContent = originalText;
                    uploadBtn.disabled = false;
                    
                    // Re-render items
                    document.getElementById('scavengerList').innerHTML = '<h2>Find & Photograph:</h2>';
                    renderItems();
                    updateScores();
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('Failed to upload photo. Please try again.');
                    const uploadBtn = input.nextElementSibling;
                    uploadBtn.textContent = 'üì∑ Add Photo';
                    uploadBtn.disabled = false;
                }
            } else {
                // Fallback to localStorage
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photo = {
                        id: photoId,
                        itemId: itemId,
                        team: selectedTeam,
                        data: e.target.result,
                        timestamp: timestamp
                    };

                    const photos = getPhotos();
                    photos.push(photo);
                    savePhotos(photos);
                    
                    // Re-render items
                    document.getElementById('scavengerList').innerHTML = '<h2>Find & Photograph:</h2>';
                    renderItems();
                    updateScores();
                };
                reader.readAsDataURL(file);
            }
        }

        // Load photos from Firebase Storage
        async function loadPhotosFromFirebase() {
            try {
                const metadataRef = firebaseStorage.ref().child('photos/metadata.json');
                
                // Try using getBytes first (avoids CORS issues) if available
                let photos;
                if (typeof metadataRef.getBytes === 'function') {
                    try {
                        const bytes = await metadataRef.getBytes();
                        const text = new TextDecoder('utf-8').decode(bytes);
                        photos = JSON.parse(text);
                        console.log('Loaded photos from Firebase using getBytes');
                    } catch (bytesError) {
                        console.log('getBytes failed, trying download URL method:', bytesError);
                        // Fall through to download URL method
                    }
                }
                
                // Fallback to download URL method if getBytes not available or failed
                if (!photos) {
                    try {
                        const url = await metadataRef.getDownloadURL();
                        // Use XMLHttpRequest instead of fetch to avoid CORS preflight
                        photos = await new Promise((resolve, reject) => {
                            const xhr = new XMLHttpRequest();
                            xhr.open('GET', url, true);
                            xhr.onload = function() {
                                if (xhr.status === 200) {
                                    try {
                                        resolve(JSON.parse(xhr.responseText));
                                    } catch (e) {
                                        reject(new Error('Failed to parse JSON: ' + e.message));
                                    }
                                } else {
                                    reject(new Error(`HTTP error! status: ${xhr.status}`));
                                }
                            };
                            xhr.onerror = function() {
                                reject(new Error('Network error'));
                            };
                            xhr.send();
                        });
                        console.log('Loaded photos from Firebase using download URL');
                    } catch (urlError) {
                        throw urlError;
                    }
                }
                
                // Merge with local photos (Firebase takes precedence for conflicts)
                const localPhotos = getPhotosLocal();
                const mergedPhotos = [...photos];
                
                // Add local photos that aren't in Firebase
                localPhotos.forEach(localPhoto => {
                    if (!mergedPhotos.find(p => p.id === localPhoto.id)) {
                        mergedPhotos.push(localPhoto);
                    }
                });
                
                savePhotosLocal(mergedPhotos);
                return true;
            } catch (error) {
                // Metadata file doesn't exist yet, that's okay
                console.log('No existing photos in Firebase, starting fresh');
                return false;
            }
        }

        // Sync photos from Firebase (for multi-device sync)
        async function syncPhotosFromFirebase() {
            if (!useFirebase || !firebaseStorage) return;
            
            try {
                const metadataRef = firebaseStorage.ref().child('photos/metadata.json');
                const url = await metadataRef.getDownloadURL();
                const response = await fetch(url);
                const firebasePhotos = await response.json();
                
                const localPhotos = getPhotosLocal();
                let needsUpdate = false;
                
                // Check if Firebase has photos we don't have locally
                firebasePhotos.forEach(fbPhoto => {
                    if (!localPhotos.find(p => p.id === fbPhoto.id)) {
                        localPhotos.push(fbPhoto);
                        needsUpdate = true;
                    }
                });
                
                if (needsUpdate) {
                    savePhotosLocal(localPhotos);
                    // Re-render items to show new photos
                    document.getElementById('scavengerList').innerHTML = '<h2>Find & Photograph:</h2>';
                    renderItems();
                    updateScores();
                }
            } catch (error) {
                // File doesn't exist or error, that's okay
            }
        }

        // Save photos metadata to Firebase
        async function savePhotosToFirebase(photos) {
            if (!useFirebase || !firebaseStorage) return;
            
            try {
                const metadataRef = firebaseStorage.ref().child('photos/metadata.json');
                const metadataJson = JSON.stringify(photos);
                const blob = new Blob([metadataJson], { type: 'application/json' });
                await metadataRef.put(blob);
            } catch (error) {
                console.error('Error saving metadata to Firebase:', error);
            }
        }

        // Get photos (from localStorage)
        function getPhotos() {
            return getPhotosLocal();
        }

        // Get photos from localStorage
        function getPhotosLocal() {
            const saved = localStorage.getItem('huntPhotos');
            return saved ? JSON.parse(saved) : [];
        }

        // Save photos (to both localStorage and Firebase)
        async function savePhotos(photos) {
            savePhotosLocal(photos);
            if (useFirebase && firebaseStorage) {
                await savePhotosToFirebase(photos);
            }
        }

        // Save photos to localStorage only
        function savePhotosLocal(photos) {
            localStorage.setItem('huntPhotos', JSON.stringify(photos));
        }

        // Get photos for item
        function getPhotosForItem(itemId) {
            return getPhotos().filter(p => p.itemId === itemId);
        }

        // Update scores
        function updateScores() {
            const photos = getPhotos();
            const momCount = photos.filter(p => p.team === 'mom').length;
            const dadCount = photos.filter(p => p.team === 'dad').length;
            
            document.getElementById('momScore').textContent = momCount;
            document.getElementById('dadScore').textContent = dadCount;
        }

        // Render gallery
        function renderGallery() {
            const container = document.getElementById('photosGallery');
            const photos = getPhotos();
            
            if (photos.length === 0) {
                container.innerHTML = '<h2>All Photos</h2><p>No photos uploaded yet.</p>';
                return;
            }

            let html = '<h2>All Photos</h2>';
            
            items.forEach(item => {
                const itemPhotos = photos.filter(p => p.itemId === item.id);
                if (itemPhotos.length > 0) {
                    itemPhotos.forEach(photo => {
                        html += `
                            <div class="photo-item">
                                <div class="photo-item-header">
                                    <div class="photo-item-title">${item.title}</div>
                                    <div class="photo-item-team ${photo.team}">${photo.team === 'mom' ? 'üë© Mom Team' : 'üë® Dad Team'}</div>
                                </div>
                                <img src="${photo.data}" alt="${item.title}" class="photo-item-image" />
                            </div>
                        `;
                    });
                }
            });
            
            container.innerHTML = html;
        }

        // View photo (placeholder for future modal)
        function viewPhoto(itemId, photoId) {
            // Could add a modal here to view full-size photo
            console.log('View photo:', itemId, photoId);
        }

        // Clear hunt - removes all data
        async function clearHunt() {
            if (!confirm('Are you sure you want to clear the hunt? This will delete all photos and reset the timer. This cannot be undone!')) {
                return;
            }

            // Stop countdown and sync
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            if (endTimeSyncInterval) {
                clearInterval(endTimeSyncInterval);
                endTimeSyncInterval = null;
            }

            // Clear end time
            endTime = null;
            localStorage.removeItem('huntEndTime');

            // Clear photos from localStorage
            localStorage.removeItem('huntPhotos');

            // Clear data from Firebase Storage
            if (useFirebase && firebaseStorage) {
                try {
                    // Clear photos
                    const photosRef = firebaseStorage.ref().child('photos');
                    const listResult = await photosRef.listAll();
                    
                    // Delete all files in the photos folder
                    const deletePromises = listResult.items.map(item => item.delete());
                    await Promise.all(deletePromises);
                    
                    // Clear end time
                    const endTimeRef = firebaseStorage.ref().child('huntEndTime.json');
                    try {
                        await endTimeRef.delete();
                    } catch (error) {
                        // File might not exist, that's okay
                    }
                    
                    console.log('Cleared data from Firebase Storage');
                } catch (error) {
                    console.error('Error clearing Firebase Storage:', error);
                }
            }

            // Reset UI
            document.getElementById('timeInputGroup').style.display = 'flex';
            document.getElementById('countdown').classList.remove('show');
            document.getElementById('huntEnded').classList.remove('show');
            document.getElementById('scoresSection').classList.remove('show');
            document.getElementById('photosGallery').classList.remove('show');
            document.getElementById('endTime').value = '';

            // Re-render items
            document.getElementById('scavengerList').innerHTML = '<h2>Find & Photograph:</h2>';
            renderItems();
            updateScores();
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
